<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="wind2412的部落格✨～">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="wind2412的部落格✨～">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="wind2412的部落格✨～">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>wind2412的部落格✨～</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-97977742-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?733fc494d1c5b28a5bef03609254381d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wind2412的部落格✨～</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/09/编译-hsdis-mac-版本，打印-jvm-执行时汇编信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/09/编译-hsdis-mac-版本，打印-jvm-执行时汇编信息/" itemprop="url">
                  编译 hsdis mac 版本，打印 jvm 执行时汇编信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-09T19:48:50+08:00">
                2018-02-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/a10y/hsdis-macos" target="_blank" rel="external">https://github.com/a10y/hsdis-macos</a></p>
<p>wget 一下，然后把 hsids-amd64.dylib 放到 <code>/Library/Java/JavaVirtualMachines/jdk1.8.0_161.jdk/Contents/Home/jre/lib/server/</code> 目录下，用 <code>java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly &lt;Java Main Class Name(no suffix)&gt;</code> 即可。<br>以及放在 debug 版本：<code>~/jvm/jdk8_mac/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib/server</code> 目录下，但是这时候要指定：<code>export LD_LIBRARY_PATH=~/jvm/jdk8_mac/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib/server</code> 才行，要不链接找不到。之后 <code>java1 -XX:+PrintAssembly &lt;Java Main Class Name(no suffix)&gt;</code> 即可。详见：<a href="http://yueyemaitian.iteye.com/blog/2042772。" target="_blank" rel="external">http://yueyemaitian.iteye.com/blog/2042772。</a></p>
<p>唉……其实在我的机器上并没有编译成功，错误信息比较诡异。所以请用上边取巧的办法。<br><del><a href="https://www.chrisnewland.com/building-hsdis-amd64dylib-on-mac-osx-376" target="_blank" rel="external">https://www.chrisnewland.com/building-hsdis-amd64dylib-on-mac-osx-376</a><br>最后需要加一个参数 ARCH=amd64…… 要不一直默认编译 i386 的……<br>用 clang 编译的，不会有问题。</del></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/28/虚拟机完成～/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/28/虚拟机完成～/" itemprop="url">
                  虚拟机完成～
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-28T21:06:00+08:00">
                2017-12-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首先甩仓库：<a href="https://github.com/wind2412/wind_jvm" target="_blank" rel="external">wind jvm</a><br>一开始只是想写一个 java 的 class file parser。后来把这东西变成了一个 tool，请左转我的<a href="https://github.com/wind2412/javap" target="_blank" rel="external">javap</a>。后来看到 @racaljk 同学用 java 实现了一个小虚拟机，感觉很有意思，遂学习了一波规范，然后写了个 C++ 的。大三下准备实习，但是还没什么能拿出手的。所以正好现在大三上有点时间，于是花了两个月写了一个。</p>
<h2 id="类似项目："><a href="#类似项目：" class="headerlink" title="类似项目："></a>类似项目：</h2><p>@racaljk 的 <a href="https://github.com/racaljk/yvm" target="_blank" rel="external">YVM</a>。不过 @racaljk 学习貌似很忙，一直没有更新QAQ。最初知道你是因为你的 hosts，实在是帮了不少忙，非常感激。而且 programming 也很强，实在佩服。<br>@lfkdsk 学长的 <a href="https://github.com/JustVM/JustVM" target="_blank" rel="external">JustVM</a>。学长实在很强，看到一堆的个人项目就五体投地了。当时我也因为 Jar 文件解包比较麻烦，看到 @lfkdsk 是直接文件读取 zip 的。因为没有现成的 zip 库也不想在上边花太多时间，所以我就采取直接把 rt.jar 全部解压的省事策略了。话说回来，大工和我们还是邻居（，而且 @lfkdsk 学长貌似也是哈尔滨人OWO。<br>以及 @zxh0 大大的 <a href="https://github.com/zxh0/jvm.go.git" target="_blank" rel="external">jvm.go</a>。虽然没学过 go 语言，不过还是能看懂一些，也参考了部分思路。<br>不过最重点的还是 openjdk 的 hotspot…… 虽然管中窥豹，不过也可以略见一斑了，学到了非常多的东西～</p>
<h2 id="具体"><a href="#具体" class="headerlink" title="具体"></a>具体</h2><p>我的 wind jvm 也就是个小玩具。代码总量用 cloc 去一下水分，也就 15k 左右。一共花了两个月代码时间，其实还有一个月是在学习各种乱七八糟的支持项目的知识。还 reference 了各种东西，列举如下：</p>
<ul>
<li>jvm8 spec</li>
<li>周志明大大的《深入理解 java 虚拟机》</li>
<li>陈涛大大的《HotSpot 实战》</li>
<li>（日）中村成洋先生的《垃圾回收的算法与实现》（中译）</li>
<li>等等。重要的还有一堆网络资源。比如 R大的 hllvm 论坛：<a href="http://hllvm.group.iteye.com" target="_blank" rel="external">hllvm论坛～</a></li>
</ul>
<h2 id="那么说下打开方式"><a href="#那么说下打开方式" class="headerlink" title="那么说下打开方式"></a>那么说下打开方式</h2><p>我的 README 上都有写，在这里重写一遍。</p>
<ol>
<li>首先我只支持 linux 和 mac。因为底层用了各种操作系统函数，pthread，stat 啥的。我的机器是 mac，所以就不支持 Windows 了。然后呢，我们需要 boost 库。用 brew 安装和 apt-get 啥的，yum 啥的都行。mac 就是 <code>brew install boost</code>，然后 ubuntu 应该是 <code>sudo apt-get install libboost-all-dev</code>。</li>
<li>这样我们就有了 boost 支持了。于是我们应该去 Makefile 修改一下，因为我配置的是我机器的环境，而且没用 cmake。所以要手动修改，把我机器上的 boost 路径目录换成你的就可以了。比如如果是 mac 的话，把 ifeq 中的 <code>$(CC) $(LINK_FLAGS) -L/usr/local/Cellar/boost/1.60.0_2/lib/ ....</code> 里边的目录换成你自己的就行。如果是 linux，就把 else 中的 <code>$(CC) $(LINK_FLAGS) -L/usr/lib/x86_64-linux-gnu/</code> 换成你自己的。不过如果是 ubuntu，八成不需要改，因为目录的版本无关。其他的 linux 就不知道了。</li>
<li>然后呢，你需要知道你的 jdk class 文件路径。mac 上，一般在 <code>/Library/Java/JavaVirtualMachines/jdk1.8xxx.jdk/Contents/Home/jre/lib/</code> 下的 rt.jar 文件。如果是 linux，一般在 <code>/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/</code> 下。配置到 config.xml 中相应位置就可以了。</li>
<li>于是应该就完事了。直接跑 make -j 8 啥的 8 线程编译就可以。当然如果你是虚拟机，虚拟内存没配置够的话就算了，直接跑 make -j 2 或者 make -j 3 这种就行了。</li>
<li>之后 <code>bin</code> 目录会出现 <code>wind_jvm</code> 这个 executable file。注意：一定要在 <code>wind_jvm/</code> 目录运行 <code>./bin/wind_jvm Test1</code> 这样的命令。因为内部我的 system lib path 是通过当前路径来获取的。如果不在 <code>wind_jvm/</code> 目录下跑，就应该会报错。然后我给了十几个 TestX.java 文件，执行 <code>make test</code> 就能编译。有一个 Test7.java 是不行的。那个只有 debug version jvm 的工具才能编译。所以我编译好了直接放上去了。然后运行 <code>./bin/wind_jvm Test1</code> 这种命令就好。不加 <code>.class</code> 后缀，参数必须有且仅有一个。</li>
<li>然后就可以玩了。不过只支持特定实现好的库，你要 socket 什么的都是没有的。不过日后实现看情况可以往上加，你也可以来 pull request 哦。</li>
<li>如果有 issue 请在 github 上上传 issue。</li>
</ol>
<h2 id="特性支持"><a href="#特性支持" class="headerlink" title="特性支持"></a>特性支持</h2><ol>
<li>完整的 ClassFileParser。那个 tool 的地址我已经刚才写过了。这东西才 3k 行多一点而已。</li>
<li>支持大部分常用反射机制。其他的是我没写的。因为太多了……不过想写的话肯定是有的。具体在 <code>src/native/sun_reflect_Reflection.hpp(cpp)</code>，<code>src/native/sun_reflect_NativeConstructorAccessorImpl.hpp(cpp)</code> 等等文件中。</li>
<li>支持底层的 Unsafe 类中的大部分。如果想要支持 jdk 类库，这个类是必须要写且必须实现的。这个类可以添加 java 不能而 C++ 能的指针操作。必须强行交换两个对象什么的。当然，还需要有少量 CAS support。并发非常必要。</li>
<li>支持简单多线程。Thread 类的底层方法是通过操作系统级别的线程支持的。比如 pthread 库。</li>
<li>支持异常机制。stack unwind 栈回溯，athrow 以及可以 catch 字节码已经处理好的异常表。Test7.java 就是测试多线程异常的。</li>
<li>支持 GC。parallel GC 支持的保证是 stop-the-world (调 bug 可是好长好长时间好痛苦哇)，使用了 GC-Root 算法，以及 GC 复制算法。见：<a href="https://github.com/wind2412/wind_jvm/blob/master/src/runtime/gc.cpp" target="_blank" rel="external">gc.cpp</a>……虽然代码量不大确是调试时间最长最难受的部分……毕竟这不是单线程 GC，是多线程的……不过我的实现肯定也是 too young 的，因为并没有各种菊苣的 paper 的支持。</li>
<li>部分支持 lambda，比如简单的 invokedynamic 类似 <code>Thread t = new Thread(() -&gt; System.out.println(&quot;hello world&quot;));</code>，Test4,5,6,8,11,13 是测试 lambda 和 invoke(MethodHandle) 的。不过很遗憾这一部分理解有些跟不上，虽然支持是比较容易，但是想要理解类库究竟是怎么实现 lambda，还需要积累和进一步研究。因此只能支持部分。[注：部分测试用例 from network]。具体实现代码请见：<a href="https://github.com/wind2412/wind_jvm/blob/master/src/runtime/bytecodeEngine.cpp#L3385-L3544" target="_blank" rel="external">invokedynamic</a>。当然不可能只有这点。这里是核心部分。还有待支持更多。</li>
<li>字节码方面，支持绝大多数，没用到的就没写（怕写错），wide 指令这种，我是没加的。</li>
</ol>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><ol>
<li>和 openjdk 一样的，klass oop 二分模型。</li>
<li>解释型。完全在解释 bytecode。因此效率上肯定差强人意。</li>
<li>按照真正的 jvm 跑 class 文件的流程运行（几乎）。初始化 mirror，初始化基础类，使用 C++ 实现的 bootstraploader，进而调用 java 的 AppClassLoader 来加载 main class。</li>
<li>每个线程配上了不同的颜色（，方便观看（其实更重要的是方便调试哇。（笑）</li>
<li>等等。细节太多了。如果你想看更多的细节，下文有字节码执行的流程输出。</li>
</ol>
<h2 id="糟粕"><a href="#糟粕" class="headerlink" title="糟粕"></a>糟粕</h2><ol>
<li>一开始什么也不会的时候，用字符串查找类……这是特别悲伤的设计。严重拖慢速度，历史遗留问题。</li>
<li>有时跑 Test7 这种多线程测试用例碰到异常的时候，最后会段错误。其实是完全可以解决的。用 pthread_cancel 配上 pthread_join 就可以完全解决。不过一开始的设计是没考虑到这么多，直接把所有线程 detach 了。如果要改，势必代码的形状会特别悲伤。所以左思右想还是维持原状，并不影响运行结果。其实这样是并不对的，java 要求某一线程抛异常，不会影响其他线程的执行。其实真正的实现是要用 join 的。</li>
<li>等等。</li>
</ol>
<h2 id="输出细节"><a href="#输出细节" class="headerlink" title="输出细节"></a>输出细节</h2><p>如果想要开启更多的细节，可以在 Makefile 中修改，原本是 <code>CPP_FLAGS := -std=c++14 -O3 -pg</code>，我在后边写了一个加上 <code>-DBYTECODE_DEBUG -DDEBUG</code> 的，启用这个就可以启用所有的字节码调试代码。引用一张月初放在博客上的图:<br><img src="https://wind2412.files.wordpress.com/2017/12/b7976a42d4d265ec2c89f1f11f6c3f69.jpg" alt="IMAGE"><br>如果还要看 classfile 的文件 parse，运行时常量池的解析，以及字符串池的常量字符串，可以打开 <code>-DKLASS_DEBUG -DPOOL_DEBUG -DSTRING_DEBUG</code> 宏，然后重新编译就好。<br>不过！如果这么打开，由于一开始初始化虚拟机，需要加载各种类，需要跑各种字节码，输出会是巨量的。没记错的话跑一个 hello world 貌似就要上十w的字节码执行量吧。因为我是解释型，自然执行的机器码比这还多；如果是编译型，那就快了。所以如果发现终端吃不消，请及时关闭。后期由于字节码输出量巨大，我从来都是关闭这些宏的，只看结果忽略执行过程。</p>
<h2 id="写文章的目的"><a href="#写文章的目的" class="headerlink" title="写文章的目的"></a>写文章的目的</h2><p>为了骗 star（，同时也是为了交友（。希望有同样爱好和兴趣的童鞋能够一起偷(yu)税(yue)地交流。那么就写到这吧。同时发到博客和知乎。</p>
<h2 id="最终的感谢"><a href="#最终的感谢" class="headerlink" title="最终的感谢"></a>最终的感谢</h2><p>感谢这个领域的先驱们，感谢各种热心的回复，感谢给我思路和灵感的人们。（热泪盈眶）<br>尤为感谢《spec》《深入java虚拟机》《hotspot实战》的作者们，以及R大的论坛和R大在知乎上传播的各种深入的虚拟机知识。实在是感激不尽！<br>另：<br>就是一个区区玩具，就不胡乱@了。供学习和交流～随便乱加了一个开源协议，虽然没什么用处就是了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/02/纪念伟大的-hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/02/纪念伟大的-hello-world/" itemprop="url">
                  纪念伟大的 hello world!
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-02T18:54:31+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>截图留念！<br>2017.12.2<br><img src="https://wind2412.files.wordpress.com/2017/12/b7976a42d4d265ec2c89f1f11f6c3f69.jpg" alt="IMAGE"><br>以上这句话由伟大的 <code>System.out.println</code> 提供技术支持～</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/27/在我的机器上-hotspot-会出现错误/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/27/在我的机器上-hotspot-会出现错误/" itemprop="url">
                  在我的机器上 ./hotspot 会出现错误
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-27T13:27:14+08:00">
                2017-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>RT。错误是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;YourOpenJDK&gt;/build/macosx-x86_64-normal-server-slowdebug/hotspot/bsd_amd64_compiler2/debug   ./hotspot</div><div class="line">Error: Cannot find the java launcher &quot;/java/re/j2se/1.8.0/promoted/latest/binaries/bsd-amd64/bin/java&quot;</div></pre></td></tr></table></figure></p>
<p>通过查找 Makefile 中 hotspot.script 文件中此错误位置发现需要引用环境变量 <code>ALT_JAVA_HOME</code>。因而只要 <code>export ALT_JAVA_HOME=&lt;YourOpenJDK&gt;/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home</code> 即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/26/VSCode-cpp-检索-include-路径的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/26/VSCode-cpp-检索-include-路径的问题/" itemprop="url">
                  VSCode cpp 检索 include 路径的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-26T11:28:48+08:00">
                2017-10-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>碰到了一个 VSCode include 路径的问题。我的项目路径在 {workspaceRoot}/include 下，一开始想要以 <code>-I./include</code> 的方式来编译的。不过在 VSCode 中遇到了些麻烦。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>使用的是 Microsoft C/C++ Extension。这个插件非常棒，但是在 mac 上因为 bug 的原因之前经常烫烫烫。好在已经 fix 了。在项目路径下的 .vscode 的文件夹下一般而言有四大金刚：<code>c_cpp_properties.json</code>，<code>launch.json</code>,<code>settings.json</code> 以及 <code>tasks.json</code>。其中 $1 用于配置 path……我都没怎么碰过这东西……还以为没啥用呢（。一般配置的都是 $2 和 $4。$3 是自动生成的用户配置，不用管就好。$2 <code>launch.json</code> 用于调试，而 <code>tasks.json</code> 用于 build &amp;&amp; run。</p>
<p>查了半天，在 VSCode 的官方博客上找到了：应该在 $1 <code>c_cpp_properties.json</code> 中配置路径。所以变成了现在这样：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">"configurations": [</div><div class="line">        &#123;</div><div class="line">            "name": "Mac",</div><div class="line">            "includePath": [</div><div class="line">                "/usr/include",</div><div class="line">                "/usr/local/include",</div><div class="line">                "/usr/include/c++/4.2.1",</div><div class="line">                "/usr/include/c++/4.2.1/tr1",</div><div class="line">                "$&#123;workspaceRoot&#125;/include"</div><div class="line">            ],</div><div class="line">            "browse": &#123;</div><div class="line">                "limitSymbolsToIncludedHeaders": true,</div><div class="line">                "databaseFilename": "",</div><div class="line">                "path": [</div><div class="line">                    "/usr/include",</div><div class="line">                    "/usr/local/include",</div><div class="line">                    "$&#123;workspaceRoot&#125;/include"</div><div class="line">                ]</div><div class="line">            &#125;,</div><div class="line">            ......</div></pre></td></tr></table></figure></p>
<p>emmmm。虽然我不知道 browse 那是什么东西。不过还是加上吧。<br>然而鬼畜的来了：特么竟然还是报错！！按官博说的，应该已经好了！！<br>痛苦地找了一个晚上。。。。。。<br>现在已经是第二天中午了QAQ。<br>正当我打开 issue，想要像 vscode-cpptools 官方 repository 上报 issue 的时候，看到了官方的提示：<strong>上报 issue 之前，请关闭其他插件。看看是否是其他插件的影响。</strong></p>
<p>上报 issue 之前，请关闭其他插件。看看是否是其他插件的影响。<br>上报 issue 之前，请关闭其他插件。看看是否是其他插件的影响。<br>上报 issue 之前，请关闭其他插件。看看是否是其他插件的影响。</p>
<p>卧槽，其实这个时候我都没怎么在意……因为另一个插件是我非常喜欢的 clang 的插件啊！虽然不是 clang 官方的（，叫 C/C++ Clang Command Adapter。是五星的插件啊！而且是个霓虹开发者开发的！OWO<br>然后我关了它。<br>竟然好了！！可以索引了！！<br>于是我看了下介绍……<br>这插件里边写的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Variables</div><div class="line"></div><div class="line">Configurations support some variables which are available in tasks.json. They can be used inside of strings (e.g. &quot;-I$&#123;workspaceRoot&#125;/include&quot;)</div><div class="line"></div><div class="line">  $&#123;workspaceRoot&#125;</div><div class="line">  $&#123;cwd&#125;</div><div class="line">  $&#123;env.ENVIRONMENT_VARIABLE&#125;</div></pre></td></tr></table></figure></p>
<p>于是我跑到 <code>settings.json</code>，加了一行这个：<br><code>&quot;clang.cxxflags&quot;: [&quot;-std=c++11&quot;, &quot;-I${workspaceRoot}/include&quot;]</code><br>然后就好了……QAQ<br>然而这就比较诡异了……在点击头文件跳转的时候，关了微软官方的插件就不能跳转；关了 clang 插件，还是能够跳转。说明 clang 插件不对跳转有任何的作用；但是，只要没有配置 args，头文件就会出现红线报错，这时微软的插件检测到错误，也不会帮你跳转……卧槽。这是插件冲突的玄学吗……</p>
<p>emmmm。下次一定要注意，别因为印象好就单独开小灶……因为真正的错误往往藏在你放心的位置，然后耽误你大量的时间……QAQ。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/25/Native-方法的探究有了小进展～～/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/25/Native-方法的探究有了小进展～～/" itemprop="url">
                  Native 方法的探究有了小进展～～
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-25T13:28:26+08:00">
                2017-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="卧槽。痛苦的一天。"><a href="#卧槽。痛苦的一天。" class="headerlink" title="卧槽。痛苦的一天。"></a>卧槽。痛苦的一天。</h1><p>因为需要读取 jar 文件，还用 C++ 语言QAQAQAQ，没有现成的库……我又不可能直接去解析……QAQ，于是就想到直接调用 Hotspot 写好的现成的 jar 文件库（我好聪明，逃。<br>然后就开始了日狗的一天。啥都没干，就一直在干动态库（。mac 的动态库 dylib 实在是气死了。但是这个设计也真是让人眼前一亮啊。学到了不少东西。</p>
<h1 id="一开始只想要调用-Java-的-Native-方法"><a href="#一开始只想要调用-Java-的-Native-方法" class="headerlink" title="一开始只想要调用 Java 的 Native 方法"></a>一开始只想要调用 Java 的 Native 方法</h1><p>想写一个小型 jvm 的话，（虽然是玩具，不过我是不可能仅仅局限于只是跑一个 hello world 这种的。自然，想要打造一个运行时环境，那么就<strong>必须能够和原生java挂钩</strong>。这是目标，同样也是底线。不能让步，如果写完了之后连 java 的类库都不能调，可以狗带了。比如说日后我要是想要实现一个 C 语言的玩具编译器的话，那么不可能仅仅调用我自己底层写的 printf，一定要调用 stdio.h 中的 printf 才好啊。但是这样的话，就肯定涉及解释执行 C 宏了。因为 stdio.h 全都是宏，大家也不是不知道。当然……就我这辣鸡水平估计是要弃坑了……不过这是一年以后的话题了。我们先放着。和这一样，如果要写一个小型 jvm，那么就必须要支持 java 类库的调用才行。要不然就只能跑自己 XJB 写的不带任何库的 java 文件，一点意义也没有。因而，必须要调用 Native 方法。但是，这时就产生了一个问题啊。这个 Native 方法，每个 Native 是不是都是纯函数呢？这是个很重要的话题呢。如果不纯，我即使强行从动态库中把他们扒出来，调用也一定会出错。因为可能这个 Native 方法还涉及到<strong>他周边的上下文环境</strong>，而我只调用了这个方法，那么肯定会出错的。这个 blog 就是一个栗子。。因为要拆包 jar 文件，我模仿 hotspot 的调用方式调用了一波 jre lib，于是代码如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">   <span class="built_in">string</span> path = <span class="string">"&lt;YourOpenJDK&gt;/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib/"</span>;  <span class="comment">// 自己编译的 jdk。如果是你的，应该路径(Mac OS)是 /Library/Java/JavaVirtualMachines/jdk1.8.0_111.jdk/Contents/Home/jre/lib/</span></div><div class="line"><span class="built_in">string</span> jvm_path = path + <span class="string">"server/"</span>;</div><div class="line"><span class="built_in">string</span> target = path + <span class="string">"libzip.dylib"</span>;  <span class="comment">// java 中，java.util.ZipFile 类的 native 文件最后全被打包成了 jre/lib 中的 libzip.dylib。在 linux 上可能是 libzip.so 吧。我们将要解包，并且调用里边 sun 公司开发者写好的 Zip_Open 函数，这个函数可以解开一个 zip 包并且读文件。源代码在 &lt;YourOpenJDK&gt;/jdk/src/share/native/java/util/zip/zip_util.c 中。</span></div><div class="line"><span class="comment">// [1] 占位符，这里一会要插入代码</span></div><div class="line"><span class="keyword">void</span> *handle = ::dlopen((target).c_str(), RTLD_LAZY); <span class="comment">// posix 的 &lt;dlfcn.h&gt; 头文件，这个头文件是 &lt;DynamicLibaryFunCtioN&gt; 的缩写。即动态库 utils。而 dlopen 函数则根据你给定的库路径，使用 RTLD_LAZY 宏采用 lazy load 的策略——即再用到此动态库的时候再解开。懒人策略。</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)handle &lt;&lt; <span class="built_in">endl</span>;  <span class="comment">// 测试。如果是 0 则说明错误。</span></div><div class="line"><span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) <span class="built_in">cout</span> &lt;&lt; dlerror(); <span class="comment">// 如果错误输出为啥错。</span></div><div class="line"><span class="keyword">void</span> *fun = ::dlsym(handle, <span class="string">"ZIP_Open"</span>);  <span class="comment">// dlsym 方法，在库中选择一个函数 ZIP_Open，然后传回地址。</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fun &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 同上，输出 0 则说明错误。</span></div></pre></td></tr></table></figure></p>
<h1 id="emmm。然后-mac-的动态库给我报错"><a href="#emmm。然后-mac-的动态库给我报错" class="headerlink" title="emmm。然后 mac 的动态库给我报错"></a>emmm。然后 mac 的动态库给我报错</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dyld: Library not loaded: @rpath/libjvm.dylib</div><div class="line">  Referenced from: &lt;此执行文件名&gt;</div><div class="line">  Reason: image not found</div></pre></td></tr></table></figure>
<p>这一段非常恶心。本质上原因是：由于你这个调用的动态库引用了别的动态库，如图：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;YourOpenJdk&gt;/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib&gt; otool -L libzip.dylib</div><div class="line">libzip.dylib:</div><div class="line">	@rpath/libzip.dylib (compatibility version 1.0.0, current version 1.0.0)</div><div class="line">	/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.5)</div><div class="line">	@rpath/libjava.dylib (compatibility version 1.0.0, current version 1.0.0)</div><div class="line">	@rpath/libjvm.dylib (compatibility version 1.0.0, current version 1.0.0)</div><div class="line">	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 169.3.0)</div></pre></td></tr></table></figure></p>
<p>我们能够发现这个动态库 libzip.dylib 引用了一堆动态库，有两个 libz.1.dylib 和 libSystem.B.dylib 是绝对路径，那么系统绝对不可能找不着。关键在于另三个：前边都有个 @rpath。<br>这个 @rpath 是执行的路径。貌似没法直接输出，只能通过强行指定才行。有的大神用 <code>otool -l libzip.dylib</code>(注意 l 小写) 然后得到了如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">Load command 11</div><div class="line">          cmd LC_LOAD_DYLIB</div><div class="line">      cmdsize 48</div><div class="line">         name @rpath/libjvm.dylib (offset 24)</div><div class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</div><div class="line">      current version 1.0.0</div><div class="line">compatibility version 1.0.0</div><div class="line">Load command 12</div><div class="line">          cmd LC_LOAD_DYLIB</div><div class="line">      cmdsize 56</div><div class="line">         name /usr/lib/libSystem.B.dylib (offset 24)</div><div class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</div><div class="line">      current version 1238.60.2</div><div class="line">compatibility version 1.0.0</div><div class="line">Load command 13</div><div class="line">          cmd LC_RPATH    // 这里！</div><div class="line">      cmdsize 32</div><div class="line">         path @loader_path/. (offset 12)</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>大概能看出来后边的 LC_RPATH 的指定位置，是 @loader_path。也就是，应该是你的可执行文件调用这个库所在的位置。比如说，我在 <code>/usr/tmp/haha</code> 这个可执行文件中调用  <code>&lt;YourOpenJdk&gt;/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib/libzip.dylib</code>，那么八成这个 <code>@loader_path</code> 只是 <code>/usr/tmp/haha</code>。然后由于 <code>@rpath</code> 是 <code>@loader_path/.</code>，那么就一样。于是 libzip.dylib 引用的 libjvm.dylib 等共三个的目录变成了 <code>/usr/tmp/libjvm.dylib</code>……应该是这样。为啥说是应该，因为我也没有验证过，存在错误的可能。不过八成是真的（逃。但是总之你是肯定索引不到真正的 libjvm.dylib 就是了，哈哈。<br>于是我们要引入 mac 的一个工具：<code>install_name_tool</code>。这个工具可以在可执行文件/动态库中加入 @rpath。由于我们正在写程序，所以不可能通过程序把自己设置 rpath。。。所以，我们只能在程序内去修改 libzip.dylib 的 rpath 了。那么我们在刚才的 [1] 处添加几行代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">string</span> cmd = <span class="string">"install_name_tool -add_rpath "</span> + jvm_path + <span class="string">" "</span> + target;</div><div class="line">system(cmd.c_str());  <span class="comment">// 执行：install_name_tool -add_rpath &lt;Your Real JVM Path&gt; &lt;Need Modified Lib/Execute File&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样就可以成功了 QAQ。我说的比较容易，其实花了我将近半天才弄完QAQ。</p>
<h1 id="调用不纯的-Native-方法是一个巨坑。"><a href="#调用不纯的-Native-方法是一个巨坑。" class="headerlink" title="调用不纯的 Native 方法是一个巨坑。"></a>调用不纯的 Native 方法是一个巨坑。</h1><p>到这一步能够解析动态库了，那么我们就开始搜刮里边的 sun 公司写好的函数了～于是加入下边的代码来 get 那个 ZIP_Open 函数～<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> *error_msg = <span class="literal">nullptr</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> ** (JNICALL *ZIPOPEN) (<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">char</span> **pmsg); <span class="comment">// jdk native 函数中 ZIP_Open 的定义。</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> * jzfile;  <span class="comment">// 意为 jar/zip file 的句柄</span></div><div class="line">ZIPOPEN zip_open = (ZIPOPEN)fun;    <span class="comment">// 函数指针强转。</span></div><div class="line">jzfile *zip = zip_open(<span class="string">"&lt;YourOpenJdk&gt;/build/macosx-x86_64-normal-server-slowdebug/jdk/lib/jce.jar"</span>, &amp;error_msg); <span class="comment">// 随手解压一个 jar 文件</span></div><div class="line"><span class="built_in">cout</span> &lt;&lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)zip &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 不是 0 则没问题。</span></div></pre></td></tr></table></figure></p>
<p>然后就开始了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line"># To suppress the following error report, specify this argument</div><div class="line"># after -XX: or in .hotspotrc:  SuppressErrorAt=/os.hpp:203</div><div class="line">......</div><div class="line">无限循环......</div></pre></td></tr></table></figure>
<p>Oh my god。<br>试了无数遍都这样，我是崩溃的！！<br>卧槽，后来仔细想了想……这一段错误提示是不是在 jvm 中的啊？？？<br>然后我在 <youropenjdk>/hotspot/src 下 grep 了一发，发现这两句出现在 <code>hotspot/src/share/vm/utilities/debug.cpp</code> 下……<br>然而！然而！！<br>我调用的 ZIP_Open 函数分明是 jdk 中的 Native 函数啊！！jdk 和 hotspot 是两个模块互不干扰，而且我就是写了一段 cpp 代码，根本没用到 jvm 啊！！<br>emmmm。细心的小伙伴肯定发现了。刚才的 libzip.dylib 引用了 libjvm.dylib。<br>那只能说明一点！！<br>（双眼一亮）<br>ZIPOpen 函数内部肯定检测了 JVM 的启动！！<br>是的就是这样。查阅源码之后我们能看到内部的各种检测自家的 JVM 启没启动的代码……<br>所以我们必须启动一个虚拟机才行。调用 JNI：<br>在整个代码的前部加上：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">int</span> res;</div><div class="line">JavaVM *jvm;</div><div class="line">JNIEnv *env;</div><div class="line">JavaVMInitArgs vm_args;</div><div class="line">JavaVMOption options[<span class="number">3</span>];</div><div class="line"></div><div class="line"><span class="comment">// 设置初始化参数：</span></div><div class="line">options[<span class="number">0</span>].optionString = <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span> *&gt;(<span class="string">"-Djava.compiler=NONE"</span>);	<span class="comment">// ISO-C++11 不允许把 const char* 转为 char*。</span></div><div class="line"><span class="comment">// classpath 有多个的时候，Windows 用 ";" 分割。 unix 用 ":" 分割。</span></div><div class="line">options[<span class="number">1</span>].optionString = <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span> *&gt;(<span class="string">"-Djava.class.path=."</span>);</div><div class="line"><span class="comment">// 用于跟踪运行时信息</span></div><div class="line">options[<span class="number">2</span>].optionString = <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span> *&gt;(<span class="string">"-verbose:jni"</span>);</div><div class="line"><span class="comment">// 版本号不能设漏</span></div><div class="line">vm_args.version = JNI_VERSION_1_6;</div><div class="line">vm_args.nOptions = <span class="number">2</span>;		<span class="comment">// 想要 JVM 的输出调试信息的话，请改为 3。</span></div><div class="line">vm_args.options = options;</div><div class="line">vm_args.ignoreUnrecognized = JNI_TRUE;</div><div class="line"></div><div class="line"> <span class="comment">// 初始化虚拟机</span></div><div class="line">res = JNI_CreateJavaVM(&amp;jvm, (<span class="keyword">void</span> **)&amp;env, &amp;vm_args);</div><div class="line"> <span class="keyword">if</span> (res == JNI_ERR) &#123;</div><div class="line"> 	<span class="built_in">cerr</span> &lt;&lt; <span class="string">"Can't create Java VM!"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"> 	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></youropenjdk></p>
<p>然后就可以了！输出就是正常的了。不过我们在编译的时候也要用 install_name_tools:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> clang++ -I/usr/include/jni -L/&lt;YourOpenJdk&gt;/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib/server/ &lt;thisFile&gt;.cc -o &lt;a.out&gt; -ljvm</div><div class="line"><span class="meta">&gt;</span> install_name_tool -add_rpath  /&lt;YourOpenJdk&gt;/build/macosx-x86_64-normal-server-slowdebug/images/j2sdk-bundle/jdk1.8.0.jdk/Contents/Home/jre/lib/server &lt;a.out&gt;</div><div class="line"><span class="meta">&gt;</span> ./a.out</div><div class="line"><span class="meta">#</span> 输出即正常！</div></pre></td></tr></table></figure></p>
<p>这说明，如果要自己写的话，Native 方法也要自己实现，不能调用人家的啊……（</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/23/解析-dylib-文件并且找到-java-native-方法的源代码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/23/解析-dylib-文件并且找到-java-native-方法的源代码/" itemprop="url">
                  解析 dylib 文件并且找到 java native 方法的源代码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-23T01:13:49+08:00">
                2017-10-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://blog.csdn.net/wangweixaut061/article/details/7164809" target="_blank" rel="external">参见博客</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nm libjava.dylib</div><div class="line">gobjdump -tT libjava.dylib  // 使用 brew install binutils 安装</div></pre></td></tr></table></figure></p>
<p>Native 方法在 Oracle Java 是不让看的。我们只能从 Openjdk 中看。我在编译好的 openjdk 源码的 build.log 中找到了一大堆 native 方法的编译 log，但是却没有发现它们到底最后被编译到哪了。而且挨个翻 Makefile 也是不太可能的（看不懂哈哈）。于是只能暴力一些了。找到 Openjdk 目录下的各种 libs，首先我的 jdk 在前一个博客也说过是 openjdk8。在 <code>&lt;yourjdk&gt;/build/macosx-x86_64-normal-server-****/jdk/lib</code> 下，有一大堆的 libs。我估计就是他们（逃）。但是怎么确认呢？请参加上方的 blog。执行那两个命令之中的任意一个。然后你就会得到一大堆的输出。然后随便找一个函数，直接在源码目录 <code>yourjdk/jdk/src/share/native</code> 目录下使用 <code>grep -rn &lt;method_name&gt; .</code> 就好了！然后发现确实能查到的！虽然不能一一对应就是了。不过这样也是大有进展，这样就可以直接调用人家写好的 Native 方法了～</p>
<p>外赠一个 shell 脚本来检查到底某个 native 方法被放到哪个 dylib 中去了：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cd &lt;yourjdk&gt;/build/macosx-x86_64-normal-server-****/jdk/lib # 此句是伪码</div><div class="line"></div><div class="line">for file in ./*</div><div class="line">do</div><div class="line">if [[ "$file" =~ "dylib$" ]]    # 以 dylib 结尾的文件</div><div class="line">then</div><div class="line">nm $file | grep registerNative | xargs -0 echo $file &#123;&#125; # registerNative 可以换成你要查找的方法名～</div><div class="line">fi</div><div class="line">done</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 输出：</div><div class="line">./libawt.dylib &#123;&#125; 00000000000403e0 T _Java_sun_java2d_loops_GraphicsPrimitiveMgr_registerNativeLoops</div><div class="line"></div><div class="line">./libhprof.dylib &#123;&#125; 000000000001ab63 T _registerNatives   # 很清晰地知道，我们要找的 registerNatives 函数在 libhprof.dylib 中～</div><div class="line"></div><div class="line">./libjava.dylib &#123;&#125; 00000000000028d0 T _Java_java_lang_ClassLoader_registerNatives</div><div class="line">0000000000002460 T _Java_java_lang_Class_registerNatives</div><div class="line">0000000000003f10 T _Java_java_lang_Compiler_registerNatives</div><div class="line">0000000000006ea0 T _Java_java_lang_Object_registerNatives</div><div class="line">00000000000096d0 T _Java_java_lang_System_registerNatives</div><div class="line">000000000000f110 T _Java_java_lang_Thread_registerNatives</div></pre></td></tr></table></figure>
<hr>
<p>随后我还是查看了 Makefile……<br>比如 libjava 的 output 指定的 Makefile 脚本在：</p>
<p><yourjdk>/jdk/make/lib/CoreLibraries.gmk 下。(gmk 即 Gnu Makefile)<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">// 116 - 129 行</div><div class="line">LIBJAVA_SRC_DIRS := <span class="variable">$(JDK_TOPDIR)</span>/src/<span class="variable">$(OPENJDK_TARGET_OS_API_DIR)</span>/native/java/lang \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/lang \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/lang/reflect \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/io \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/<span class="variable">$(OPENJDK_TARGET_OS_API_DIR)</span>/native/java/io \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/nio \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/security \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/common \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/sun/misc \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/sun/reflect \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/util \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/share/native/java/util/concurrent/atomic \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/<span class="variable">$(OPENJDK_TARGET_OS_API_DIR)</span>/native/common \</div><div class="line">    <span class="variable">$(JDK_TOPDIR)</span>/src/<span class="variable">$(OPENJDK_TARGET_OS_API_DIR)</span>/native/java/util</div><div class="line"><span class="comment"># 这一部分指出了 libjava 的 src。所有的这些 Native 文件最后都被打包成为 libjava.dylib 的一部分。</span></div><div class="line"></div><div class="line">// 220 - 224 行</div><div class="line"><span class="variable">$(BUILD_LIBJAVA)</span>: <span class="variable">$(LIBJLI_BINARY)</span>  <span class="comment"># 这个命令开始 build libjli.dylib，在 &lt;yourjdk&gt;/build/macosx-x86_64-normal-server-****/jdk/lib/ 下</span></div><div class="line"></div><div class="line"><span class="variable">$(BUILD_LIBJAVA)</span>: <span class="variable">$(BUILD_LIBVERIFY)</span>  <span class="comment"># 这个命令开始 build libverify.dylib，位置同上</span></div><div class="line"></div><div class="line"><span class="variable">$(BUILD_LIBJAVA)</span>: <span class="variable">$(BUILD_LIBFDLIBM)</span>    <span class="comment"># 这个命令开始 build libfdlibm.a，在 &lt;yourjdk&gt;/build/macosx-x86_64-normal-server-****/jdk/obj/ 下。</span></div><div class="line"></div><div class="line"><span class="comment"># libjava.dylib 依赖这三个 lib。</span></div></pre></td></tr></table></figure></yourjdk></p>
<p>嗯嗯。还想要继续找的话，请各种使用 grep 命令会方便很多～</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/20/Mac-环境使用-clang-编译-OpenJDK8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/20/Mac-环境使用-clang-编译-OpenJDK8/" itemprop="url">
                  Mac 环境使用 clang 编译 OpenJDK8
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-20T10:19:22+08:00">
                2017-10-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="经历"><a href="#经历" class="headerlink" title="经历"></a>经历</h1><p>搞了 3 个晚上，终于搞定了。在 mac 上各种版本不适配，也是很有意思的～需要折腾，需要折腾～</p>
<hr>
<h1 id="参看博客："><a href="#参看博客：" class="headerlink" title="参看博客："></a>参看博客：</h1><p><a href="https://github.com/ydcun/Java/blob/master/java/src/main/java/com/ydcun/openjdk/jdk8/MAC编译OpenJDK8.md" target="_blank" rel="external">主要参照</a><br><a href="http://www.guinguo.top/2016/05/03/JVM学习之OpenJDK源码编译/" target="_blank" rel="external">主要参照的补充: 编译 debug 版 openjdk</a><br><a href="http://hllvm.group.iteye.com/group/topic/39814#post-260210" target="_blank" rel="external">R大的答案</a><br><a href="http://blog.csdn.net/lizhengjava/article/details/60138890" target="_blank" rel="external">很好的博客</a><br><a href="https://stackoverflow.com/a/21443288/7093297" target="_blank" rel="external">重点！对 mac 下 libiconv 的操作</a><br><a href="https://yddmax.github.io/2017/06/12/openjdk8之编译和debug/" target="_blank" rel="external">调试你的 openjdk</a></p>
<hr>
<h1 id="历程"><a href="#历程" class="headerlink" title="历程"></a>历程</h1><p>按照<code>主要参照</code>的 github 上边的过程一步步来，注意要使用 clang 而不是 gcc。其实在 mac 就应该使用 clang，因为 gcc 不知道会引发什么潜在的隐患那…… 而且 clang 生成的调试信息貌似要比 gcc 好些吧。但是要注意：如果你想要调试的话，就要看看<code>主要参照的补充</code>那个博客了。因为 <code>sh configure</code> 后边需要有参数。我将会列在下边。</p>
<hr>
<h1 id="各种版本："><a href="#各种版本：" class="headerlink" title="各种版本："></a>各种版本：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt; clang -v</div><div class="line">Apple LLVM version 8.1.0 (clang-802.0.42)</div><div class="line">Target: x86_64-apple-darwin16.7.0</div><div class="line">Thread model: posix</div><div class="line">InstalledDir: /usr/bin</div><div class="line"></div><div class="line">&gt; clang++ -v</div><div class="line">Apple LLVM version 8.1.0 (clang-802.0.42)</div><div class="line">Target: x86_64-apple-darwin16.7.0</div><div class="line">Thread model: posix</div><div class="line">InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin</div><div class="line"></div><div class="line">&gt; java -version</div><div class="line">java version &quot;1.8.0_111&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_111-b14)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)</div></pre></td></tr></table></figure>
<ol>
<li>以上即是各种 tools 的信息。注意，最好开着 VPN 进行 hg 的 pull 操作。因为这样下载速度会飙得很快～ 而且用 hg 貌似易于更新的话说。</li>
<li>其中，XQuartz 请下载最新的官网版本。不要用<code>主要参照</code>给出的链接，请自行使用 <code>brew cask install XQuartz</code> 来进行 brew 安装。因为链接给出的 XQuartz 版本太老了，是 SnowLeopard 版本的 mac 才适配的。</li>
<li><code>xcode-select -install</code> 在我这里已经没用了。不过貌似工具链完整，也不需要安装了。</li>
<li>编译开始之前，请一定要把 <code>/usr/bin/gcc</code> 和 <code>/usr/bin/g++</code> 改成 <code>clang</code> 和 <code>clang++</code>！因为 <code>./configure</code> 的时候会搜索这两个路径确认编译器 <code>gcc</code> 以及 <code>g++</code>。当然，如果你原先没有做过交叉编译啥的修改过 <code>/usr/bin/gcc</code> 和 <code>/usr/bin/g++</code> 的话，那么请忽略我这些话。</li>
<li>我的 shell 脚本，参照了一堆人的脚本，列举如下。我自己略加修改：<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 设定语言选项，必须设置</div><div class="line">export LANG=C</div><div class="line"><span class="meta">#</span> Mac平台，C编译器不再是GCC，是clang</div><div class="line">export CC=gcc</div><div class="line"><span class="meta">#</span> 跳过clang的一些严格的语法检查，不然会将N多的警告作为Error</div><div class="line">export COMPILER_WARNINGS_FATAL=false</div><div class="line"><span class="meta">#</span> 链接时使用的参数</div><div class="line">export LFLAGS='-Xlinker -lstdc++'</div><div class="line"><span class="meta">#</span> 是否使用clang</div><div class="line">export USE_CLANG=true</div><div class="line"><span class="meta">#</span> 使用64位数据模型</div><div class="line">export LP64=1</div><div class="line"><span class="meta">#</span> 告诉编译平台是64位，不然会按32位来编译</div><div class="line">export ARCH_DATA_MODEL=64</div><div class="line"><span class="meta">#</span> 允许自动下载依赖</div><div class="line">export ALLOW_DOWNLOADS=true</div><div class="line"><span class="meta">#</span> 并行编译的线程数，编译时间长，为了不影响其他工作，我选择为2</div><div class="line">export HOTSPOT_BUILD_JOBS=6</div><div class="line">export ALT_PARALLEL_COMPILE_JOBS=6</div><div class="line"><span class="meta">#</span> 是否跳过与先前版本的比较</div><div class="line">export SKIP_COMPARE_IMAGES=true</div><div class="line"><span class="meta">#</span> 是否使用预编译头文件，加快编译速度</div><div class="line">export USE_PRECOMPILED_HEADER=true</div><div class="line"><span class="meta">#</span> 是否使用增量编译</div><div class="line">export INCREMENTAL_BUILD=true</div><div class="line"><span class="meta">#</span> 编译内容</div><div class="line">export BUILD_LANGTOOLS=true</div><div class="line">export BUILD_JAXP=false</div><div class="line">export BUILD_JAXWS=false</div><div class="line">export BUILD_CORBA=false</div><div class="line">export BUILD_HOTSPOT=true</div><div class="line">export BUILD_JDK=true</div><div class="line"><span class="meta">#</span> 编译版本</div><div class="line">export SKIP_DEBUG_BUILD=true</div><div class="line">export SKIP_FASTDEBUG_BUILD=false</div><div class="line">export DEBUG_NAME=debug</div><div class="line"><span class="meta">#</span> 避开javaws和浏览器Java插件之类的部分的build</div><div class="line">export BUILD_DEPLOY=false</div><div class="line">export BUILD_INSTALL=false</div><div class="line"><span class="meta">#</span> 加上产生调试信息时需要的 objcopy</div><div class="line"><span class="meta">#</span> export OBJCOPY=gobjcopy</div></pre></td></tr></table></figure>
</li>
</ol>
<p>把它命名为 <code>jvm.sh</code> 的话，我们只需要执行 <code>source ./jvm.sh</code> 即可把临时环境变量设置好。</p>
<ol>
<li><code>主要参照</code> 的所有问题都遇到了。不得不说这是十分良心的经验～</li>
<li>不过，如果你要进行调试的话，需要把一开始的 <code>sh configure</code> 变成：<code>sh configure --with-target-bits=64 --with-debug-level=slowdebug --enable-debug-symbols ZIP_DEBUGINFO_FILES=0</code>。这样就会产生足够多数量的调试信息，方便调试～</li>
<li>如果你遵循了第 6 条，那么最后会提示你缺少 <code>objcopy</code>。那么请使用 <code>brew install binutils</code> 来安装 GNU 的组件，并且把 <code>jvm.sh</code> 的最后一行取消注释才行！</li>
<li>然后愉快地 make all 即可！</li>
</ol>
<hr>
<h1 id="坑们"><a href="#坑们" class="headerlink" title="坑们"></a>坑们</h1><p>在我这里只出现了一个大坑，然而弄到了半夜QAQ。就是当编译 <code>make all</code> 的时候，到了编译 jdk 的时候，编译了一半出现了诡异的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Undefined symbols for architecture x86_64:</div><div class="line">  &quot;_libiconv&quot;, referenced from:</div><div class="line">  ......</div><div class="line">  &quot;_libiconv_close&quot;, referenced from:</div><div class="line">  ......</div><div class="line">  &quot;_libiconv_open&quot;, referenced from:</div><div class="line">  ......</div></pre></td></tr></table></figure></p>
<p>这种狗血的错误。然后一看名就知道了……分明应该是 libiconv 的问题……然而特么一查，电脑中有各种 <code>libiconv.dylib</code> 包，还有各种花式的 <code>libiconv.2.dylib</code> 以及 <code>libiconv.2.4.0.dylib</code>…… 而且散布在不同目录下……我都不知道链接哪个才是正确的……于是不得不上网查，谷歌谷不出来还是百度百出来的（逃，(因为可能是谷歌不支持特殊字符的原因吧……)，然后就查到了有一个回答支持，链接也贴出来了：<a href="https://stackoverflow.com/a/21443288/7093297" target="_blank" rel="external">重点！对 mac 下 libiconv 的操作</a>。这个回答只要做第一步就好。即，把 <code>/usr/lib/libiconv.dylib</code> 变成 <code>/usr/lib/libiconv1.dylib</code> 即可，让链接库找不到就 ok。结果链接的是 <code>/usr/bin</code> 目录下的这个文件……其实 <code>/usr/local/bin/</code> 里边还有同名的一套 libiconv 呢……<br>不过改完之后就能碰到 <code>主要参照</code> 的第三个错误了，照改不误就可以。对于这份 github 的经验实在是感激不尽！帮了大忙。</p>
<hr>
<h1 id="世界的终结"><a href="#世界的终结" class="headerlink" title="世界的终结"></a>世界的终结</h1><p>打开你自己的 <code>build/macosx-x86_64-normal-server-slowdebug/jdk/bin</code> 目录，然后 <code>./java</code>，出现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">用法: java [-options] class [args...]</div><div class="line">           (执行类)</div><div class="line">   或  java [-options] -jar jarfile [args...]</div><div class="line">           (执行 jar 文件)</div><div class="line">其中选项包括:</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>就算大功告成！<br>但是，如果没有出现这，而是出现什么类似 <code>某个文件800行有问题，提示你编译不完全</code> 的错误提示的话，那你怕是要返工了。当时在 Docker 下 的 ubuntu 虚拟机编译的（其实我就把它当轻量的虚拟机来用HAHA，当时就出现了这个错误。而且错误信息中显示时间戳不对，肯定是编译的过程中出了些岔子吧。</p>
<p>如果你产生了调试信息，那么可以参见 <code>调试你的 openjdk</code> 的最后方，有调试的方法，很简单～</p>
<p>Enjoy it！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/15/使用-mac-同步-Markdown-的方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/15/使用-mac-同步-Markdown-的方法/" itemprop="url">
                  使用 mac 同步 Markdown 的方法......
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-15T23:47:19+08:00">
                2017-10-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用 Quiver 写完之后，导出为 Markdown 然后放在一个文件夹下，然后用 MWeb 进行导入，但是导入后的图片格式会有 Quiver 自动生成的<code>xxx = 380x300</code>这种图片格式，需要用正则替换：<code>\s=[0-9]+x[0-9]+</code> 替换成全空字符即可，这样图片格式就只剩下原先的<code>xxx</code>了，而后边由 Quiver 自动生成的图片尺寸格式就会被正则删除了。然后，用 MWeb 直接发布到 wordpress 上，由于 MWeb 会直接转成 wordpress 的图片地址，所以直接就可以发布上去；但是，如果仅仅正常发布的话，我们就只能看到最后的结果，但是却并不能得到 Markdown 的格式。所以最后我们需要勾选：<strong>发布为 Markdown 格式</strong> 这个选项！然后发布到 wordpress 上，之后直接复制粘贴所有的，然后本地 hexo new 之后复制粘贴即可……关键问题是我特别喜欢用 Quiver 写，但是 Quiver 还没有一键发布的功能……所以只能采用这样间接迂回的方案了……不过这样也特别快速，不过唯一的缺点就是最后要手动清理发布的 wordpress 版本和本地由 Quiver 导出的 Markdown 了……但是其他的使用体验还是相当棒的！欢迎来尝试～其实如果你用 MWeb 这种就可以的话，那么 MWeb 一键就可以上传～不过我更喜欢 Quiver 的界面～</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/15/Design-Pattern-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wind2412">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blue_sky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wind2412的部落格✨～">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/15/Design-Pattern-2/" itemprop="url">
                  Design Pattern 2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-15T23:32:10+08:00">
                2017-10-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前的笔记实在是有些简陋，如今要正式地重来一遍咯！</p>
<ol>
<li>Observer<br><img src="https://wind2412.files.wordpress.com/2017/10/1312de348af17c9be249c3ab6be49d9d5.jpg" alt="IMAGE">￼<br>如 UML 图所见，Subject 和 Object 都是接口，仅仅定义了对于模式实现的方法，而 ConcreteSubject 和 ConcreteObject 才是实现类。</li>
</ol>
<ul>
<li>对象模型：Subject 中含有一个 Object 的 List，代表它要通知的 Objects。而每一个 Object 中含有一个对自己 Subject 的引用。</li>
<li><code>pull模式</code>：Subject 中的 <code>Notify()</code> 方法以及 Object 中的 <code>Update()</code> 方法才是重点。<code>Subject::Notify()</code> 使用轮询的方式来调用它内部每个 Object 的 <code>Object::Update()</code> 方法。而 <code>Object::Update()</code> 方法往往又调用 Subject 的 <code>Subject::getState()</code> 方法来拉取状态。其实这就是 Observer 的 <code>pull方法</code>，即由 Observer 自身去拉取的手段。</li>
<li><code>push模式</code>：当然对应地，还有种实现手段是 <code>push方法</code>。即 Subject 调用 <code>Subject::Notify()</code> 开启 <code>Object::Update()</code> 的时候。传入自身的 State 进去。这样 Object 在实现 <code>Object::Update()</code> 的时候，就不去要从 Subject 中 pull 来，因为 Subject 已经 push 过去了。但是这样实现，弹性比较小，正常的标准还是 <code>pull模式</code>。</li>
</ul>
<ol>
<li>Strategy<br><img src="https://wind2412.files.wordpress.com/2017/10/fce70ae306b54ea1b7b6b5b6fd290b5b5.jpg" alt="IMAGE">￼<br>如 UML 图所见，Strategy 是接口类，仅仅定义了 strategy 接口。而同一层继承体系下，分化出来多个 ConcreteStrategy 类。</li>
</ol>
<ul>
<li>对象模型：Context 的内部内含一个 Strategy 对象的引用。而 Strategy 是一个接口体系，可以在同一层继承下分化出来多个 SubStrategy。</li>
<li>过程：举 awt 的栗子来说：<br><img src="https://wind2412.files.wordpress.com/2017/10/8d1cf8f82e31ee611840d3bddd9057745.jpg" alt="IMAGE">￼<br>“<code>Java
JFrame jframe(…); // JFrame 是 Container 的一个子对象，即 Context
jFrame.setLayout(new FlowLayout()); // 添加一个 Strategy 到 Context 中。
jframe.add(new JButton()); // JFrame::add 方法会在内部调用 FlowLayout 的 Strategy 方法，产生一种布局模式。
“</code></li>
<li>更多的栗子：同样的栗子还有：Sorter 内部存放一个 SorterStrategy 的引用，可以赋值为 SorterStrategy 体系下的 SubStrategy，必须 BinarySortStrategy 对象，BubbleSortStrategy 对象，HeapSortStrategy 对象等等。<br><img src="https://wind2412.files.wordpress.com/2017/10/56f57bc0b7c0fb8ff0175350742298695.jpg" alt="IMAGE">￼</li>
<li>还有游戏一进去就有的选择困难等级：容易、中等、难、困难、修罗模式这种，也是策略模式的体现！</li>
</ul>
<ol>
<li>Factory<br><img src="https://wind2412.files.wordpress.com/2017/10/30edc0e01dc0e46bfd304a7c148629155.jpg" alt="IMAGE">￼<br>如 UML 图所见，Product 是一个抽象产品类，下方有继承的 ConcreteProduct 实体的产品类。Creator 是接口工厂，内含多态的 <code>Creator::FactoryMethod</code> 方法，返回一个集成体系下的顶层抽象产品类 <code>Product</code>。ConcreteCreator 是实体工厂，用于生产 ConcreteProduct。</li>
</ol>
<ul>
<li>对象模型：Creator 工厂内部没有任何成员变量，只有工厂方法。但是 Creator 工厂内部的方法可以全是 static 的。这就是一种变种，叫做<strong>静态工厂</strong>。好处在于，不用创建工厂的实体对象了～</li>
<li>变种1：简单的工厂方法：不需要写抽象的 Creator，因为体系比较简单，直接上来就是一个简单的<strong>实体+静态</strong>工厂。<br><img src="https://wind2412.files.wordpress.com/2017/10/caee8f1c304c496071c1651af4f905425.jpg" alt="IMAGE">￼</li>
<li>变种2：对于生产同一个继承体系的多种产品，可以在工厂中只写一个方法，内部使用 <code>if…elif…else</code> 的手段，最后产生的对象挂接到高层产品接口的句柄上返回。<br><img src="https://wind2412.files.wordpress.com/2017/10/fe8365b2de82f7458eab45e955db7a1b5.jpg" alt="IMAGE">￼<br>如图，此 Concrete Factory 的 <code>produce()</code> 方法签名返回高层的 Product。</li>
<li>变种3：Product <strong>接口</strong>自己就是一个工厂，可以使用多态(子Product 中分别实现)产生继承体系下的多种类型的 ConcreteProduct。当然，这个多态工厂方法必然返回 <code>Product*</code> 的句柄就是，而且可以使用 <code>static</code> 静态方法。<br><img src="https://wind2412.files.wordpress.com/2017/10/883674d07e93c884378e08391d7408225.jpg" alt="IMAGE">￼</li>
<li>变种4：ConcreteProduct 本身是一个工厂，可以产生自己。(我们只有一种产品)<br><img src="https://wind2412.files.wordpress.com/2017/10/d912ac56240eb34fb7fb7738a44d9c225.jpg" alt="IMAGE">￼</li>
<li>用途：Java 框架中的依赖注入(IoC中) 等等。</li>
</ul>
<ol>
<li>Abstract Factory<br><img src="https://wind2412.files.wordpress.com/2017/10/76a70e7dcedf267ef963bb7468975d395.jpg" alt="IMAGE">￼<br>和 Factory 的不同之处仅仅在于，</li>
</ol>
<ul>
<li>Abstract Factory 是把工厂自身当做产品的。即，<strong>生产工厂的工厂</strong>。</li>
<li>Abstract Factory 由于有上边的这种性质，因此它不再局限于只能像 Factory 一样仅仅能够生产一个体系中的 Product。通过生产出不同类别的工厂，它能够自扩展而生产别的体系的 Product。我们从 UML 图即可看出。</li>
<li>缺点：支持新种类的 Product 变得很麻烦了。</li>
</ul>
<ol>
<li>Decorator<br><img src="https://wind2412.files.wordpress.com/2017/10/cf598de9f6bc240de26a397558351b735.jpg" alt="IMAGE">￼<br>如 UML 图可见，最高层是一个抽象类 Component。它下方<strong>一定有一个</strong>直属的子类 ConcreteComponent，要不 Decorator 无法使用了。因为 Decorator 虽然也继承 Component，但是它的内部也有一个 Component 的句柄引用！那个句柄引用的正体显而易见就是那个直属的 ConcreteComponent。因为装饰者模式的策略就是：<strong>在同一继承体系中，使用已经实现好的子类，在新的子类中扩展它的功能，变成新的功能。</strong></li>
</ol>
<ul>
<li>对象模型：ConcreteComponent 成员变量不能有同类的 Component 句柄，但是 Decorator 的内部必须有一个同类的 Component 句柄！因为 Decorator 要对 ConcreteComponent 的功能进行扩展，从而衍生出自己的新功能，而不用完全从头来写。Decorator 的构造函数要传递一个被扩展的同体系的对象，UML 图中即是 ConcreteComponent。</li>
<li>经典用途：Java 的 IO 系统。比如 BufferedInputStream 啥的都是继承自上层的 InputStream，但是自己构造的时候又要接收一个 InputStream 对象。<br><img src="https://wind2412.files.wordpress.com/2017/10/ec3f046a48a6b71d7a10d88e93891da95.jpg" alt="IMAGE">￼</li>
<li>这也就给出了：<strong>为什么不在类上用继承进行扩展呢</strong> 这个问题的真正答案。很简单，<strong>因为装饰者模式比继承要灵活，弹性更大</strong>。像我们的 BufferedInputStream，既可以接收别的 FileInputStream，也可以满足比如来自 Socket 的 socket.getInputStream() 的接收这样的场景。所以，如果上层有其他的 InputStream 体系的实现，BufferedInputStream 这个装饰者可以对他们进行<strong>统一扩展</strong>，而不再仅仅局限于继承的<strong>仅仅扩展一个InputStream</strong>。这样弹性会变得非常巨大～</li>
</ul>
<ol>
<li>Singleton<br><img src="https://wind2412.files.wordpress.com/2017/10/50c2e92f282a4c20e6452fe9f296d7af5.jpg" alt="IMAGE">￼<br>这个实在是基础中的基础，不讲了。但是在多线程之下，Java 中 Singleton 模式也是有很多大坑的，尤其是 LazyEvaluation。<br><a href="http://blog.csdn.net/haoel/article/details/4028232" target="_blank" rel="external">单例模式的博客</a><br><strong>不过要换成 C++，就连 Eager Singleton 也有大坑！！！</strong><br>一开始，我认为只有这样，用 <code>shared_ptr</code> 智能指针才行：<br>“`cpp<br>// 错误的 Singleton 范例！！<br>class Singleton{<br>private:<br>static shared_ptr singleton;<br>Singleton() {}<br>public:<br>static shared_ptr getSingleton() {<br>return singleton;<br>}<br>};</li>
</ol>
<p>shared_ptr Singleton::singleton = shared_ptr(new Singleton); // 用原生指针 new 一个 static 变量，最后会造成内存无法释放而泄漏。<br>“<code>上边的想法确实在我自己看来是还中规中矩的……不过这两天正好读完了 Scott Meyers 的 Effective C++……其中的第四条款指出，static 这种全局变量，虽然会在使用时初始化，但是和 Java 也有本质的不同。Java 的话，在虚拟机 JVM 进行类加载的时候，会有一个“类的初始化”期，这期间会直接初始化所有 static 变量和 static 块。因此，Eager Singleton 在 Java 中可谓是天然适配，上来就默认多线程友好；但是 C++ 不一样……确实在调用之前，static 也会初始化；但是 C++ 标准并没有规定 **多个编译单元中 static 的初始化顺序**！！也就是，在多个模块中，non-local static 变量的初始化顺序是未知的！具体原因请直接看 Meyers 的 Effective C++ Item 04。因此，Meyers 指出，在 C++ 想要 Singleton 安全，必须把 non-local static 变成一个 local static，其实表现形式上，变成了一个**工厂函数**！更改后的程序见下：
“</code>cpp<br>// 正确的 Eager Singleton，而且不再使用恶心的 static new！<br>class Singleton{<br>private:<br>Singleton();<br>Singleton(const Singleton &amp;);<br>Singleton&amp; operator= (const Singleton &amp;);<br>~Singleton();<br>public:<br>static Singleton&amp; getSingleton() {<br>static Singleton singleton;<br>return singleton;<br>}<br>};// 注意一定要注销掉 copy constructor 以及 constructor 还有 assignment operator！！要不，最后会发生可以拷贝的愚蠢现象……比如 Singleton s = getSingleton()，因为调用的是拷贝构造函数……所以必须 private 化。因为 C++ 可以分配在栈上，因此和 Java 全是堆引用不同～<br>“`<br>参考了一个博客：<a href="http://www.zkt.name/dan-li-mo-shi-singleton-ji-c-shi-xian/" target="_blank" rel="external">ZKT的笔记本</a>，在我迷惑的时候它帮助了我。当然，虽然还没有看，但是《Modern C++ Design》中用 TMP 来 hack 各种设计模式也非常令人憧憬～<br>至此单例模式完成……没想到竟然引申出了这么多东西……颇有收获～<br>多例模式的话，就 new 一个 ArrayList 就可以。布局和 FlyWeight 模式有点像，不过那个的内部是一个 HashMap。</p>
<ol>
<li>Command<br><img src="https://wind2412.files.wordpress.com/2017/10/2e97319afd4ddc3eba303d08f697b9d95.jpg" alt="IMAGE">￼<br>如 UML 图可见，Client 客户端先要创建一个具有<strong>各种</strong>动作的 Receiver，虽然 GOF 只画了一个 Action()。其实内部可以有 ActionEat()，ActionDrink()，ActionPlay() 等。而 Command 的分化也可以有 ConcreteEatCommand，ConcreteDrinkCommand 以及 ConcretePlayCommand 等分化类，用于持久化各种 Action 命令。</li>
</ol>
<ul>
<li>对象模型：Command 是一个抽象类，内部有一个引用的成员 Receiver 和一个 Execute 方法，Execute 旨在调用 <code>多个 receiver.action()</code>，从而把 <code>receiver.action()</code> 延后化。即，把 <code>receiver.action()</code> 这个瞬间的调用给封装成了一个 Command 对象藉以持久化，达到推迟 <code>receiver.action()</code> 执行的最终目的。ConcreteCommand 是一个实现类。Invoker 其实就是一个 List 的封装，把所有的动作全都使用 Command 延时化，然后集结到一块，通过 <code>Invoker::invoke()</code> 来进行一块执行所有 Command 达到最终的延时操作 actions 的目的，即 MacroCommand。</li>
<li>变种：Undo and Redo：<br>可以通过和 <code>Command::Execute()</code> 方法并列编写一个 <code>Command::Undo()</code> 方法。比如 <code>Command::Execute() { receiver.turnOnLightAction(); }</code>，那么 <code>Command::Undo() { receiver.turnOffLightAction(); }</code> 就可以被如此实现。</li>
<li>用途：执行一系列延时操作；打 Log。</li>
</ul>
<ol>
<li>Adapter</li>
</ol>
<ul>
<li>类配接器：<br><img src="https://wind2412.files.wordpress.com/2017/10/e56b2aa09933ce0b15f10a8553fbcdf45.jpg" alt="IMAGE">￼<br>如 UML 图可见，Adaptee 是一个我们原本拥有的、但是和正规接口不符的要被配接的对象。我们使用多继承，继承自 Target 和 Adaptee，产生一个新的 Adapter，实现 Target 的正规接口，内部只要调用 <code>Adaptee::SpecificRequest()</code> 即可。其实十分简单。</li>
<li>对象配接器：<br><img src="https://wind2412.files.wordpress.com/2017/10/720cb5b7588de99cbba8591f81d801485.jpg" alt="IMAGE">￼<br>如 UML 图可见，Adapter 使用了<strong>聚合</strong>的方式代替了<strong>继承</strong>的方式。STL 中的容器配接器 stack 也是这么实现的。同样，在 <code>Adapter::Request()</code> 中直接调用 <code>Adaptee::SpecificRequest()</code> 即可。</li>
</ul>
<ol>
<li>Facade<br><img src="https://wind2412.files.wordpress.com/2017/10/dd29d76640a3ad798d850cf165b29ea65.jpg" alt="IMAGE">￼<br><img src="https://wind2412.files.wordpress.com/2017/10/60840b6915e310bd41f35c597047b67d5.jpg" alt="IMAGE">￼<br>外观模式更像一种软件的<strong>架构模式</strong>，因此没有 UML 图。外观模式其实在我的理解类似于<strong>模块化</strong>，通过<strong>模块化</strong>的方式来定制多种模块接口，来呈现出美观的外观。<strong>子系统内部的任何变化不会影响到 Facade 接口的变化</strong>！</li>
<li>Template Method<br><img src="https://wind2412.files.wordpress.com/2017/10/c139a82646cce7bf8eefa811e2e2cd675.jpg" alt="IMAGE">￼<br>如 UML 图可见，我们在一个抽象类 AbstractClass 中写下 <code>TemplateMethod()</code> 方法，内部指定代码逻辑的实现，分别按顺序调用 <code>PrimitiveOperation1</code> 和 <code>PrimitiveOperation2</code> 这两个方法。然后后二者使用多态，可以在子类中自由变更。但是 <code>TemplateMethod()</code> 方法永远保持不变。</li>
</ol>
<ul>
<li>应用：<code>HttpServlet</code> 中的 <code>doGet()</code>，<code>doPost()</code> 等多种方法。注意它们的命名用 <code>do-</code> 前缀开头。而且在 Servlet 的大逻辑的实现中，这些 <code>do-</code> 方法是按照 TemplateMethod 模式，按照一定的逻辑进行调用的。我们所更改的只是 <code>doGet()</code> 和 <code>doPost()</code> 的内部逻辑，但是外部的大框架逻辑并没有改变！</li>
</ul>
<ol>
<li>Iterator<br><img src="https://wind2412.files.wordpress.com/2017/10/14e23d3cdf0170d021302d2dd20071c45.jpg" alt="IMAGE">￼<br>迭代器分有内部、外部、静态、动态多种。不过大多数都是内部的“标准”迭代器。C++ STL 完全基于迭代器，让容器的遍历和容器自身完全分离开来，而且可以让外部无法知道容器内部的细节。几乎是最常用的设计模式之一，不过多解释了。</li>
<li>Compose<br><img src="https://wind2412.files.wordpress.com/2017/10/285bac2a709397cceea0e8ec0604f3725.jpg" alt="IMAGE">￼<br>组合模式最常见的就是树形结构。其实它的结构和 Decorator 有些像，但是作用是天壤之别。</li>
</ol>
<ul>
<li>例子：这个模式用例子来解释是最好的，就是文件系统。抽象的文件类就是 Component 这个抽象组件节点类，而 File 就是 Leaf，Folder 就是 Composite：它的内部含有一个 <code>List</code>，即 Folder 中可以含有 File，更可以含有其他 Folder。那么这个 UML 图就非常明了了。注意 Compose 模式的重点是树形结构就好。</li>
</ul>
<ol>
<li>State<br><img src="https://wind2412.files.wordpress.com/2017/10/f8f4476696a6fca66a1e7175002951a45.jpg" alt="IMAGE">￼<br>状态模式和策略模式比较像。只不过，Strategy 模式中，一个 state 对应多个 Strategy；而 State 模式中，多个 State 都有自己的不同的行为。<br><img src="https://wind2412.files.wordpress.com/2017/10/bff35faa62e1430a019da7c33ad1134a5.jpg" alt="IMAGE">￼<br>如上图，每个 Tool 子类都重写了 Tool 接口的四个方法。其实这和 Strategy 真的差不多。只不过 State 模式不同对象代表不同的状态，而 Strategy 总体是在一个大状态之下，而选择了不同的 Strategy 而已。</li>
<li>Proxy<br><img src="https://wind2412.files.wordpress.com/2017/10/5b47674319622e5d539b8d37bd249fa95.jpg" alt="IMAGE">￼<br>由此 UML 图可见，Proxy 和 RealSubject 都继承自 Subject 这个抽象类。都有 Request 方法。而 Proxy 的内部具有一个 RealSubject 的句柄，而 <code>Proxy::Request()</code> 的内部则是调用了 <code>realSubject-&gt;Request()</code>。即，Proxy 代理 RealSubject 来进行 RealSubject 的职务。</li>
</ol>
<ul>
<li>用途：比如网络的代理软件、操作系统的软链接、智能指针等等。</li>
</ul>
<ol>
<li>FlyWeight<br><img src="https://wind2412.files.wordpress.com/2017/10/e1582dcbab60854bcd2b7e69afcdf4485.jpg" alt="IMAGE">￼<br>FlyWeight 模式一般都自带一个工厂，工厂一般都可以是 Singleton Factory，内部一般存放一个 HashMap。其实在个人看来，C++ 的 <code>map</code> 就非常符合 FlyWeight 的观念，尤其是它重载的 <code>operator []</code>。FlyWeight 模式在向内调用 <code>FlyWeightFactory::GetKey(Key key)</code> 方法的时候，如果 key 在内部的 HashMap 中已经存放过，那么就直接取出来<strong>它的句柄</strong>，把句柄返回去。如果没有存放过，那么就把此 Key 的句柄放到 HashMap 中存放。</li>
<li>Builder<br><img src="https://wind2412.files.wordpress.com/2017/10/7188b5194eab3777f3ca91bf0e11876f5.jpg" alt="IMAGE">￼</li>
</ol>
<ul>
<li>对象模型：Builder 模式中，有一个 Director 占据主导地位。<code>Director::construct()</code> 是拼装组件的入口函数。Director 内部有一个 Builder 的 reference。Director 通过调用 <code>builder.buildPartA, builder.buildPartB, builder.buildPartC</code> 在 builder 内部产生多个组件。而这个 <code>Builder::retrieveInstance</code> 内部会由 Builder 内部所维护的成员变量 <code>partA, partB, partC</code> 来进行 construct 出一个 Product。<strong>注意：在 Builder 内部维护的成员变量仅仅是成员组件 partA/B/C，只有在 retrieveInstance 的时候才会真的生成一个 Product</strong>。</li>
<li>如果把 Director 省略掉，那么就和 Factory 差不多了。不过 construct 函数要被从 Director 中迁移到 Builder 中，并且必须在 retrieveInstance 之前调用。</li>
</ul>
<ol>
<li>Chain of Responsiblity<br><img src="https://wind2412.files.wordpress.com/2017/10/5d578416becac7dc0b76953784e5edc15.jpg" alt="IMAGE">￼</li>
</ol>
<ul>
<li>对象模型：Handler 类本质上是一个单向链表，next 即是自己。内部含有 <code>HandleRequest()</code> 方法，用来处理这个 Handler。当然，Handler 可以派生出多种类型，然后共同组成一个链。<code>HandleRequest()</code> 是会对此节点及之后的所有节点做处理的。所以只要在第一个节点处调用 <code>HandleRequest()</code> 即可。</li>
</ul>
<ol>
<li>Mediator<br><img src="https://wind2412.files.wordpress.com/2017/10/708294e4ad7e9589d9428b566c2739695.jpg" alt="IMAGE">￼<br>中介者模式主要是为了避免过度耦合的现象发生的。比如同事，在软件工程的原理中，如果没有中介人，那么同事之间要两两互相认识，太麻烦了。因此中介人即是起到保存所有同事的作用；而且每个同事之中还要保存中介人的引用。</li>
</ol>
<ul>
<li>对象模型：如上边所说，每个 College 之中要保存 Mediator；而 Mediator 中保存了所有的 Colledges。</li>
</ul>
<ol>
<li>Bridge<br><img src="https://wind2412.files.wordpress.com/2017/10/4b705ee83c2e02890742b823e1f71cb25.jpg" alt="IMAGE">￼<br>Wikipedia：如“圆形”、“三角形”归于抽象的“形状”之下，而“画圆”、“画三角”归于实现行为的“画图”类之下，然后由“形状”调用“画图”。<br>即：将类的功能层次结构和实现层次结构分离。<br><img src="https://wind2412.files.wordpress.com/2017/10/edf285b882377c3cbe2fe46ce3d2e1705.jpg" alt="IMAGE">￼<br>如图，各个方法的实现全部放在 DisplayImpl 中去，而 Display 和 CountDisplay 中拥有 DisplayImpl 实现方法对象，可以调用 Display 的各个实现方法组合成不同的实现。比如打印一次或者五次。</li>
<li>Prototype<br><img src="https://wind2412.files.wordpress.com/2017/10/590872f2a29e7491aa7bf16caeba276f5.jpg" alt="IMAGE">￼<br>其实就是 Java 的 Cloneable 接口。根据深拷贝而形成的 Clone 方法。其实和 C++ 的 copy constructor 差不多。但是实现中要防止循环引用的深拷贝。</li>
<li>Memento<br><img src="https://wind2412.files.wordpress.com/2017/10/dcd6357fca367eab319d1da20bebbf8e5.jpg" alt="IMAGE">￼</li>
</ol>
<ul>
<li>对象模型：备忘录模式具有 Memento、Originator 以及 Caretaker 三个组件。Memento 在这里是一个 bean，内部具有一个 state 成员，标志着状态。而 <code>Originator::SetMemento()</code> 接收一个 Memento，拆包并且把 state 设置为自己的 state。而 <code>Originator::CreateMemento()</code> 会再把 state 封包成一个 Memento 返回出去。而 Caretaker 即是一个 List，存放多个 Memento。</li>
<li>注意：这三者职责非常明确。Memento 只是一个包装类，只有包装的作用；Originator 原发器具有<strong>读取备忘录</strong> 的作用；而 Caretaker 只有<strong>保存备忘录以及转发</strong>的作用，并没有查看备忘录的权限。</li>
<li>注意2：概念：宽接口 —— 正常的功能齐全的接口 窄接口 —— 啥功能都没有的接口。对 Originator 会提供 Memento 的宽接口；而对于其他的类则提供 Memento 的窄接口 —— MementoIF。而其实 MementoIF 是定义在全局的，而 Originator 中才定义了 Memento 继承于 MementoIF。也就是，只有 Originator 才能解开 MementoIF 的秘密～<br><a href="https://github.com/LexHsu/Summary/blob/master/07-DesignPatten/book/14-memento.md" target="_blank" rel="external">备忘录模式详解</a></li>
<li>对所有对象都提供正常的 Memento 的，叫做<strong>白箱 Memento 模式</strong>；而只对于 Originator 才提供正常宽接口 Memento 的，对于其他对象统统提供 MementoIF 的，叫做<strong>黑箱 Memento 模式</strong>。这种模式对于封装性非常有用！！</li>
</ul>
<ol>
<li>Visitor<br><img src="https://wind2412.files.wordpress.com/2017/10/3c931985494c55527214300c5b8d80d15.jpg" alt="IMAGE">￼<br>Visitor 模式非常有用，也很复杂。写 parser 必备。各种 AST 子节点都需要 visitor 模式来进行对子节点的一一访问，配上模板的类型推导可食用。具体代码见我的上一篇博客。</li>
<li>Interpreter<br><img src="https://wind2412.files.wordpress.com/2017/10/9da4079e58aa31abdafc117162ceaed55.jpg" alt="IMAGE">￼<br>解释器模式就略了。其实就是写一个简单的 parser。非终结符和终结符，就是类似 BNF 范式。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/blue_sky.jpg"
               alt="wind2412" />
          <p class="site-author-name" itemprop="name">wind2412</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wind2412" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接o(*////▽////*)q
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.google.com/" title="Google~" target="_blank">Google~</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wind2412</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    

    
  





  






  





  

  

  

  

  

</body>
</html>
